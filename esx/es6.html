<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ES6 | PXFED</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="icon" href="/pxfed/favicon.ico">
    <meta name="description" content="Just playing around">
    <link rel="preload" href="/pxfed/assets/css/0.styles.79d2b74d.css" as="style"><link rel="preload" href="/pxfed/assets/js/app.391c752e.js" as="script"><link rel="preload" href="/pxfed/assets/js/2.197eb809.js" as="script"><link rel="preload" href="/pxfed/assets/js/14.6499c987.js" as="script"><link rel="prefetch" href="/pxfed/assets/js/10.f981e27f.js"><link rel="prefetch" href="/pxfed/assets/js/11.50cedf1f.js"><link rel="prefetch" href="/pxfed/assets/js/12.5eaf23ae.js"><link rel="prefetch" href="/pxfed/assets/js/13.51a07a3e.js"><link rel="prefetch" href="/pxfed/assets/js/15.00256b2a.js"><link rel="prefetch" href="/pxfed/assets/js/16.b5fe4aca.js"><link rel="prefetch" href="/pxfed/assets/js/17.e32d600f.js"><link rel="prefetch" href="/pxfed/assets/js/18.b1e50332.js"><link rel="prefetch" href="/pxfed/assets/js/19.d1de6dc1.js"><link rel="prefetch" href="/pxfed/assets/js/20.a3867248.js"><link rel="prefetch" href="/pxfed/assets/js/21.ecaaacfc.js"><link rel="prefetch" href="/pxfed/assets/js/22.180ace57.js"><link rel="prefetch" href="/pxfed/assets/js/23.f07d1b4f.js"><link rel="prefetch" href="/pxfed/assets/js/24.51665be9.js"><link rel="prefetch" href="/pxfed/assets/js/25.053f7e9a.js"><link rel="prefetch" href="/pxfed/assets/js/26.cb3007ea.js"><link rel="prefetch" href="/pxfed/assets/js/27.e00f13e6.js"><link rel="prefetch" href="/pxfed/assets/js/28.6595e37e.js"><link rel="prefetch" href="/pxfed/assets/js/29.9750a7bb.js"><link rel="prefetch" href="/pxfed/assets/js/3.9f21a8e2.js"><link rel="prefetch" href="/pxfed/assets/js/30.f97323f5.js"><link rel="prefetch" href="/pxfed/assets/js/31.00250396.js"><link rel="prefetch" href="/pxfed/assets/js/32.f4b3cf1e.js"><link rel="prefetch" href="/pxfed/assets/js/33.50557d64.js"><link rel="prefetch" href="/pxfed/assets/js/34.0e0bb241.js"><link rel="prefetch" href="/pxfed/assets/js/35.e507bf03.js"><link rel="prefetch" href="/pxfed/assets/js/36.545140ca.js"><link rel="prefetch" href="/pxfed/assets/js/37.4333939e.js"><link rel="prefetch" href="/pxfed/assets/js/38.1210eda9.js"><link rel="prefetch" href="/pxfed/assets/js/39.5e31bab1.js"><link rel="prefetch" href="/pxfed/assets/js/4.f23e151d.js"><link rel="prefetch" href="/pxfed/assets/js/40.705d7c1d.js"><link rel="prefetch" href="/pxfed/assets/js/41.33c976ce.js"><link rel="prefetch" href="/pxfed/assets/js/42.1ced0f2e.js"><link rel="prefetch" href="/pxfed/assets/js/43.4b446d33.js"><link rel="prefetch" href="/pxfed/assets/js/44.402b0312.js"><link rel="prefetch" href="/pxfed/assets/js/45.e933ff8c.js"><link rel="prefetch" href="/pxfed/assets/js/46.426aa448.js"><link rel="prefetch" href="/pxfed/assets/js/47.686c8539.js"><link rel="prefetch" href="/pxfed/assets/js/48.0ab858a7.js"><link rel="prefetch" href="/pxfed/assets/js/5.ff934079.js"><link rel="prefetch" href="/pxfed/assets/js/6.761b8afb.js"><link rel="prefetch" href="/pxfed/assets/js/7.d9e89e79.js"><link rel="prefetch" href="/pxfed/assets/js/8.898087c3.js"><link rel="prefetch" href="/pxfed/assets/js/9.ccb0218d.js">
    <link rel="stylesheet" href="/pxfed/assets/css/0.styles.79d2b74d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/pxfed/" class="home-link router-link-active"><img src="/pxfed/logo.png" alt="PXFED" class="logo"> <span class="site-name can-hide">PXFED</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/pxfed/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/pxfed/esx/" class="nav-link router-link-active">
  Esx
</a></div><div class="nav-item"><a href="/pxfed/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/pxfed/nodejs/" class="nav-link">
  Nodejs
</a></div><div class="nav-item"><a href="/pxfed/solutions/" class="nav-link">
  Solutions
</a></div><div class="nav-item"><a href="/pxfed/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><a href="/pxfed/dv/" class="nav-link">
  Dv
</a></div><div class="nav-item"><a href="/pxfed/py/" class="nav-link">
  Py
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/pxfed/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/pxfed/esx/" class="nav-link router-link-active">
  Esx
</a></div><div class="nav-item"><a href="/pxfed/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/pxfed/nodejs/" class="nav-link">
  Nodejs
</a></div><div class="nav-item"><a href="/pxfed/solutions/" class="nav-link">
  Solutions
</a></div><div class="nav-item"><a href="/pxfed/db/" class="nav-link">
  DB
</a></div><div class="nav-item"><a href="/pxfed/dv/" class="nav-link">
  Dv
</a></div><div class="nav-item"><a href="/pxfed/py/" class="nav-link">
  Py
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Esx</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pxfed/esx/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/pxfed/esx/es5.html" class="sidebar-link">es5</a></li><li><a href="/pxfed/esx/es6.html" aria-current="page" class="active sidebar-link">ES6</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#promise" class="sidebar-link">Promise</a></li><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#class" class="sidebar-link">Class</a></li><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#判断对象是否是数组-对象的元素-属性" class="sidebar-link">判断对象是否是数组/对象的元素/属性</a></li><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#对象数组去重" class="sidebar-link">对象数组去重</a></li><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#proxy" class="sidebar-link">Proxy</a></li><li class="sidebar-sub-header"><a href="/pxfed/esx/es6.html#reflect" class="sidebar-link">Reflect</a></li></ul></li><li><a href="/pxfed/esx/es9.html" class="sidebar-link">ES9</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="es6"><a href="#es6" class="header-anchor">#</a> ES6</h1> <h2 id="promise"><a href="#promise" class="header-anchor">#</a> Promise</h2> <h3 id="语法"><a href="#语法" class="header-anchor">#</a> 语法</h3> <div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span> <span class="token comment">/* executor */</span>  <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h3> <p>三种状态：</p> <ul><li>pending: 初始状态，既不是成功，也不是失败状态。</li> <li>fulfilled: 意味着操作成功完成。</li> <li>rejected: 意味着操作失败。</li></ul> <p>Promise.prototype.then 和 Promise.prototype.catch 方法返回 promise 对象，可支持链式调用</p> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <p><a href="https://promisesaplus.com/" target="_blank" rel="noopener noreferrer">Promise/A+规范<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ol><li>术语</li></ol> <ul><li>promise：an object or function with a then method</li> <li>thenable： an object or function that defines a then method.</li> <li>value： promise resolve value, including undefined, a thenable, or a promise</li> <li>exception： a value that is thrown using the throw statement.</li> <li>reason: promise reject reason</li></ul> <ol start="2"><li>需求</li></ol> <p>状态</p> <ul><li>pending 必须转换成 fulfilled 或者 rejected 状态</li> <li>fulfilled 不能改变为任何其他状态，且必须返回一个 value</li> <li>rejected 不能改变为任何其他状态，且必须返回一个 reason</li></ul> <p>then</p> <blockquote><p>Promise 必须提供一个 then 方法来处理 value 或者 rason,then 方法包含两个参数：promise.then(onFulfilled, onRejected)</p></blockquote> <ul><li>onFulfilled, onRejected 为可选参数，如果不是 function,必须忽略</li> <li>如果 onFulfilled 为 function， 必须在 promise 状态为 fulfilled 后调用，且以 value 为第一个参数，必须调用不止一次</li> <li>如果 onRejected 为 function， 必须在 promise 状态为 rejected 后调用，且以 rason 为第一个参数，必须调用不止一次</li> <li>onFulfilled or onRejected must not be called until the execution context stack contains only platform code. --- promise 必须为异步，可使用 setTimeout 来实现</li> <li>onFulfilled 和 onRejected 必须作为 function 调用（既没有 this 值）</li> <li>then 可以被调用多次，存储 resolve 和 reject 队列，在调用 resolve 和 reject 方法时，需要将队列中存放的回调按照先后顺序依次调用</li> <li>then 必须返回一个 promise: promise2 = promise1.then(onFulfilled, onRejected);
<ul><li>如果有一个 onFulfilled 或 onRejected 返回一个值 x，请运行 Promise Resolution Procedure [[Resolve]](promise2, x)。</li> <li>如果任何一个 onFulfilled 或 onRejected 引发异常 e，则 promise2 必须 e 以其为理由予以拒绝。</li> <li>如果 onFulfilled 不是 function 且 promise1 已 fulfilled，则 promise2 必须使用与相同的值来实现 promise1。</li> <li>如果 onRejected 不是 function 而 promise1 被 rejected，则 promise2 必须以与相同的理由将其拒绝 promise1。</li></ul></li></ul> <p>Promise Resolution Procedure</p> <blockquote><p>resolvePromise(promise2, x, resolve, reject)</p></blockquote> <ul><li>如果 promise2 和 x 相等，那么 reject promise with a TypeError</li> <li>如果 x 是一个 promsie
<ul><li>如果 x 是 pending 态，那么 promise 必须要在 pending,直到 x 变成 fulfilled or rejected.</li> <li>如果 x 被 fulfilled, fulfill promise with the same value.</li> <li>如果 x 被 rejected, reject promise with the same reason.</li></ul></li> <li>如果 x 是一个 object 或者 是一个 function
<ul><li>let then = x.then.</li> <li>如果 x.then 这步出错，那么 reject promise with e as the reason..</li> <li>如果 then 是一个函数，then.call(x, resolvePromiseFn, rejectPromise)
<ul><li>resolvePromiseFn 的 入参是 y, 执行 resolvePromise(promise2, y, resolve, reject);</li> <li>rejectPromise 的 入参是 r, reject promise with r.</li> <li>如果 resolvePromise 和 rejectPromise 都调用了，那么第一个调用优先，后面的调用忽略。</li> <li>如果调用 then 抛出异常 e
<ul><li>如果 resolvePromise 或 rejectPromise 已经被调用，那么忽略</li> <li>否则，reject promise with e as the reason</li></ul></li></ul></li> <li>如果 then 不是一个 function. fulfill promise with x.</li></ul></li> <li>如果 x 不是一个 object 或者 function，fulfill promise with x.</li></ul> <p>源码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//test.js</span>
<span class="token keyword">class</span> <span class="token class-name">MyPromise</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">exector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'pending'</span> <span class="token comment">//pending, fulfilled, or rejected.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span> <span class="token comment">//</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolve <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>reject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>exector<span class="token punctuation">)</span> <span class="token comment">// fn</span>
  <span class="token punctuation">}</span>

  <span class="token function">init</span><span class="token punctuation">(</span><span class="token parameter">exector</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exector <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'resolver must be a funciton'</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">exector</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resolve<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">//改变执行顺序</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token string">'rejected'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onFulfilled<span class="token punctuation">,</span> onRejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onFulfilled <span class="token operator">=</span>
      <span class="token keyword">typeof</span> onFulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFulfilled</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value
    onRejected <span class="token operator">=</span>
      <span class="token keyword">typeof</span> onRejected <span class="token operator">===</span> <span class="token string">'function'</span>
        <span class="token operator">?</span> <span class="token function-variable function">onRejected</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> reason
          <span class="token punctuation">}</span>
    <span class="token keyword">let</span> p2
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'fulfilled'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">(</span>p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 向对了中装入 onFulfilled 和 onRejected 函数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onFulfilledCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onFulfilled</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
            MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallback<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token function">onRejected</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
            MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// console.log(this.onFulfilledCallback);</span>
        <span class="token comment">// console.log(this.onRejectedCallback);</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">p2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> called <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">/**
     * 2.3.1 If promise and x refer to the same object, reject promise with a TypeError as the reason.
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span>
          <span class="token string">'cannot return the same promise object from onfulfilled or on rejected callback.'</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 处理返回值是 Promise 对象的情况</span>
      <span class="token comment">/**
       * new MyPromise(resolve =&gt; {
       *  resolve(&quot;Success&quot;)
       * }).then(data =&gt; {
       *  return new MyPromise(resolve =&gt; {
       *    resolve(&quot;Success2&quot;)
       *  })
       * })
       */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>status <span class="token operator">===</span> MyPromise<span class="token punctuation">.</span><span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 2.3.2.1 If x is pending, promise must remain pending until x is fulfilled or rejected.
         */</span>
        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
          <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// 用 x 的 fulfilled 后的 value 值 y，去设置 p2 的状态</span>
            <span class="token comment">// 上面的注视，展示了返回 Promise 对象的情况，这里调用 then 方法的原因</span>
            <span class="token comment">// 就是通过参数 y 或者 reason，获取到 x 中的 value/reason</span>

            <span class="token comment">// 拿到 y 的值后，使用 y 的值来改变 p2 的状态</span>
            <span class="token comment">// 依照上例，上面生成的 Promise 对象，其 value 应该是 Success2</span>

            <span class="token comment">// 这个 y 值，也有可能是新的 Promise，因此要递归的进行解析，例如下面这种情况</span>

            <span class="token comment">/**
             * new Promise(resolve =&gt; {
             *  resolve(&quot;Success&quot;)
             * }).then(data =&gt; {
             *  return new Promise(resolve =&gt; {
             *    resolve(new Promise(resolve =&gt; {
             *      resolve(&quot;Success3&quot;)
             *    }))
             *  })
             * }).then(data =&gt; console.log(data))
             */</span>

            MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 2.3 If x is a thenable, it attempts to make promise adopt the state of x,
         * under the assumption that x behaves at least somewhat like a promise.
         *
         * 2.3.2 If x is a promise, adopt its state [3.4]:
         * 2.3.2.2 If/when x is fulfilled, fulfill promise with the same value.
         * 2.3.2.4 If/when x is rejected, reject promise with the same reason.
         */</span>
        x<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token comment">/**
       * 2.3.3 Otherwise, if x is an object or function,
       */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">/**
       * 2.3.3.1 Let then be x.then.
       * 2.3.3.2 If retrieving the property x.then results in a thrown exception e, reject promise with e as the reason.
       */</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// then 方法可能设置了访问限制（setter），因此这里进行了错误捕获处理</span>
        <span class="token keyword">const</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">/**
           * 2.3.3.2 If retrieving the property x.then results in a thrown exception e,
           * reject promise with e as the reason.
           */</span>

          <span class="token comment">/**
           * 2.3.3.3.1 If/when resolvePromise is called with a value y, run [[Resolve]](promise, y).
           * 2.3.3.3.2 If/when rejectPromise is called with a reason r, reject promise with r.
           */</span>

          <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
            x<span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter">y</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token comment">/**
               * If both resolvePromise and rejectPromise are called,
               * or multiple calls to the same argument are made,
               * the first call takes precedence, and any further calls are ignored.
               */</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span>
              MyPromise<span class="token punctuation">.</span><span class="token function">resolvePromise</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token parameter">r</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
              called <span class="token operator">=</span> <span class="token boolean">true</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * 2.3.3.3.4 If calling then throws an exception e,
         * 2.3.3.3.4.1 If resolvePromise or rejectPromise have been called, ignore it.
         * 2.3.3.3.4.2 Otherwise, reject promise with e as the reason.
         */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span>
        called <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// If x is not an object or function, fulfill promise with x.</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">catch</span><span class="token punctuation">(</span>rejectFn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> rejectFn<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>验证是否符合 Promise A+规范</p> <blockquote><p><a href="https://github.com/promises-aplus/promises-tests" target="_blank" rel="noopener noreferrer">测试<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>将如下代码加入 MyPromise(test.js)</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// tests</span>
MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> defer <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  defer<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    defer<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve
    defer<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> defer
<span class="token punctuation">}</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>修改 package.json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;promises-aplus-tests ./test.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code> <span class="token comment">#promises-aplus-tests</span>
 <span class="token function">npm</span> i -D promises-aplus-tests
 <span class="token comment"># test</span>
 <span class="token function">npm</span> run <span class="token builtin class-name">test</span>

</code></pre></div><h2 id="class"><a href="#class" class="header-anchor">#</a> Class</h2> <div class="language-js extra-class"><pre class="language-js"><code>Class Dog<span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'puppy'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> dog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>dog<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre></div><h3 id="extends"><a href="#extends" class="header-anchor">#</a> extends</h3> <blockquote><p>extends 关键字用来创建一个普通类或者内建对象的子类。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Polygon</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Here, it calls the parent class' constructor with lengths</span>
    <span class="token comment">// provided for the Polygon's width and height</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> length<span class="token punctuation">)</span>
    <span class="token comment">// Note: In derived classes, super() must be called before you</span>
    <span class="token comment">// can use 'this'. Leaving this out will cause a reference error.</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">'Square'</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">get</span> <span class="token function">area</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="static"><a href="#static" class="header-anchor">#</a> static</h3> <blockquote><p>类（class）通过 static 关键字定义静态方法。不能在类的实例上调用静态方法，而应该通过类本身调用。这些通常是实用程序方法，例如创建或克隆对象的功能。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ClassWithStaticMethod</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> staticProperty <span class="token operator">=</span> <span class="token string">'someValue'</span>
  <span class="token keyword">static</span> <span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'static method has been called.'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ClassWithStaticMethod<span class="token punctuation">.</span>staticProperty<span class="token punctuation">)</span>
<span class="token comment">// output: &quot;someValue&quot;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ClassWithStaticMethod<span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// output: &quot;static method has been called.&quot;</span>
</code></pre></div><p>调用静态方法</p> <p>1.静态方法调用同一个类中的其他静态方法，可使用 this 关键字。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">StaticMethodCall</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'Static method has been called'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">anotherStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' from another static method'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
StaticMethodCall<span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 'Static method has been called'</span>

StaticMethodCall<span class="token punctuation">.</span><span class="token function">anotherStaticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 'Static method has been called from another static method'</span>
</code></pre></div><p>2.非静态方法中，不能直接使用 this 关键字来访问静态方法。而是要用类名来调用：CLASSNAME.STATIC_METHOD_NAME() ，或者用构造函数的属性来调用该方法： this.constructor.STATIC_METHOD_NAME().</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">StaticMethodCall</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>StaticMethodCall<span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 'static method has been called.'</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>constructor<span class="token punctuation">.</span><span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// 'static method has been called.'</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">staticMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'static method has been called.'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="判断对象是否是数组-对象的元素-属性"><a href="#判断对象是否是数组-对象的元素-属性" class="header-anchor">#</a> 判断对象是否是数组/对象的元素/属性</h2> <p>格式：（变量 in 对象）</p> <p>当‘对象’是数组时：“变量”指的是数组的“索引”；</p> <p>当‘对象’为对象是，“变量”指的是对象的“属性”。</p> <h2 id="对象数组去重"><a href="#对象数组去重" class="header-anchor">#</a> 对象数组去重</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> tmp <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  tmp<span class="token punctuation">[</span>next<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">[</span>next<span class="token punctuation">.</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token operator">&amp;&amp;</span> item<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> item
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="proxy"><a href="#proxy" class="header-anchor">#</a> Proxy</h2> <blockquote><p>https://segmentfault.com/a/1190000019198822</p></blockquote> <p>基础用法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Tom'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> handler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'getting '</span> <span class="token operator">+</span> key<span class="token punctuation">)</span>
    <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// 不是target.key</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setting '</span> <span class="token operator">+</span> key<span class="token punctuation">)</span>
    target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> handler<span class="token punctuation">)</span>
proxy<span class="token punctuation">.</span>name <span class="token comment">// 实际执行 handler.get</span>
proxy<span class="token punctuation">.</span>age <span class="token operator">=</span> <span class="token number">25</span> <span class="token comment">// 实际执行 handler.set</span>
<span class="token comment">// getting name</span>
<span class="token comment">// setting age</span>
<span class="token comment">// 25</span>
</code></pre></div><p>handler 对象方法</p> <blockquote><p>handler 对象是一个容纳一批特定属性的占位符对象。它包含有 Proxy 的各个捕获器（trap）。所有的捕捉器是可选的。如果没有定义某个捕捉器，那么就会保留源对象的默认行为。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code>handler<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.getPrototypeOf 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.setPrototypeOf 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.isExtensible 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.preventExtensions 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.getOwnPropertyDescriptor 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.defineProperty 方法的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//in 操作符的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//属性读取操作的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//属性设置操作的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//delete 操作符的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//Object.getOwnPropertyNames 方法和 Object.getOwnPropertySymbols 方法的捕捉器。</span>
<span class="token function">handler</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//函数调用操作的捕捉器。</span>
handler<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//new 操作符的捕捉器。</span>
</code></pre></div><p><a href="https://segmentfault.com/a/1190000019198822" target="_blank" rel="noopener noreferrer">与 Object.defineProperty 的区别<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>支持数组</li> <li>针对整个对象</li> <li>嵌套</li></ul> <p><a href="https://segmentfault.com/a/1190000006035363" target="_blank" rel="noopener noreferrer">应用场景<svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ul><li>数据校验</li> <li>私有属性</li> <li>访问日志</li> <li>预计拦截</li> <li>过滤操作</li> <li>中断代理</li></ul> <h2 id="reflect"><a href="#reflect" class="header-anchor">#</a> Reflect</h2> <blockquote><p>与大多数全局对象不同 Reflect 并非一个构造函数，所以不能通过 new 运算符对其进行调用，或者将 Reflect 对象作为一个函数来调用。Reflect 的所有属性和方法都是静态的（就像 Math 对象）。</p></blockquote> <p>静态方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Reflect</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> thisArgument<span class="token punctuation">,</span> argumentsList<span class="token punctuation">)</span>
<span class="token comment">//对一个函数进行调用操作，同时可以传入一个数组作为调用参数。和 Function.prototype.apply() 功能类似。</span>
Reflect<span class="token punctuation">.</span><span class="token function">construct</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> argumentsList<span class="token punctuation">[</span><span class="token punctuation">,</span> newTarget<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 对构造函数进行 new 操作，相当于执行 new target(...args)。</span>
Reflect<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">,</span> attributes<span class="token punctuation">)</span>
<span class="token comment">// 和 Object.defineProperty() 类似。如果设置成功就会返回 true</span>
Reflect<span class="token punctuation">.</span><span class="token function">deleteProperty</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">)</span>
<span class="token comment">// 作为函数的delete操作符，相当于执行 delete target[name]。</span>
Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">[</span><span class="token punctuation">,</span> receiver<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 获取对象身上某个属性的值，类似于 target[name]。</span>
Reflect<span class="token punctuation">.</span><span class="token function">getOwnPropertyDescriptor</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">)</span>
<span class="token comment">// 类似于 Object.getOwnPropertyDescriptor()。如果对象中存在该属性，则返回对应的属性描述符,  否则返回 undefined.</span>
Reflect<span class="token punctuation">.</span><span class="token function">getPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token comment">// 类似于 Object.getPrototypeOf()。</span>
Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">)</span>
<span class="token comment">// 判断一个对象是否存在某个属性，和 in 运算符 的功能完全相同。</span>
Reflect<span class="token punctuation">.</span><span class="token function">isExtensible</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token comment">// 类似于 Object.isExtensible().</span>
Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token comment">// 返回一个包含所有自身属性（不包含继承属性）的数组。(类似于 Object.keys(), 但不会受enumerable影响).</span>
Reflect<span class="token punctuation">.</span><span class="token function">preventExtensions</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
<span class="token comment">// 类似于 Object.preventExtensions()。返回一个Boolean。</span>
Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> propertyKey<span class="token punctuation">,</span> value<span class="token punctuation">[</span><span class="token punctuation">,</span> receiver<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 将值分配给属性的函数。返回一个Boolean，如果更新成功，则返回true。</span>
Reflect<span class="token punctuation">.</span><span class="token function">setPrototypeOf</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> prototype<span class="token punctuation">)</span>
<span class="token comment">// 设置对象原型的函数. 返回一个 Boolean， 如果更新成功，则返回true。</span>
</code></pre></div><p>示例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 检测一个对象是否存在特定属性</span>
<span class="token keyword">const</span> duck <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Maurice'</span><span class="token punctuation">,</span>
  color<span class="token operator">:</span> <span class="token string">'white'</span><span class="token punctuation">,</span>
  <span class="token function-variable function">greeting</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Quaaaack! My name is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>duck<span class="token punctuation">,</span> <span class="token string">'color'</span><span class="token punctuation">)</span>
<span class="token comment">// true</span>
Reflect<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>duck<span class="token punctuation">,</span> <span class="token string">'haircut'</span><span class="token punctuation">)</span>
<span class="token comment">// false</span>
<span class="token comment">// 返回这个对象自身的属性</span>
Reflect<span class="token punctuation">.</span><span class="token function">ownKeys</span><span class="token punctuation">(</span>duck<span class="token punctuation">)</span>
<span class="token comment">// [ &quot;name&quot;, &quot;color&quot;, &quot;greeting&quot; ]</span>
<span class="token comment">// 为这个对象添加一个新的属性</span>
Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>duck<span class="token punctuation">,</span> <span class="token string">'eyes'</span><span class="token punctuation">,</span> <span class="token string">'black'</span><span class="token punctuation">)</span>
<span class="token comment">// returns &quot;true&quot; if successful</span>
<span class="token comment">// &quot;duck&quot; now contains the property &quot;eyes: 'black'&quot;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/12/2020, 6:02:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pxfed/esx/es5.html" class="prev">
        es5
      </a></span> <span class="next"><a href="/pxfed/esx/es9.html">
        ES9
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/pxfed/assets/js/app.391c752e.js" defer></script><script src="/pxfed/assets/js/2.197eb809.js" defer></script><script src="/pxfed/assets/js/14.6499c987.js" defer></script>
  </body>
</html>
